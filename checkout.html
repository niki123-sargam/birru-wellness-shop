<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Checkout — Birru Wellness</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f6f8fb; --card:#fff; --primary:#0b6b9e; --muted:#6b7280; --radius:12px; --shadow:rgba(10,20,30,0.06); --max-width:900px;
    }
    body{font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto, Arial; background:var(--bg); margin:0; color:#222}
    .container{max-width:var(--max-width); margin:28px auto; padding:20px}
    .grid{display:grid; grid-template-columns:1fr 320px; gap:20px}
    .card{background:var(--card); border-radius:var(--radius); padding:16px; box-shadow:0 8px 30px var(--shadow)}
    input,textarea{width:100%; padding:10px; border-radius:8px; border:1px solid #eef2f6; margin-bottom:10px}
    .pay-btn{background:linear-gradient(90deg,var(--primary),#0f7fb3); color:white; padding:12px 16px;border-radius:10px;border:none;cursor:pointer;font-weight:700;width:100%}
    .summary-line{display:flex;justify-content:space-between;color:var(--muted); margin:6px 0}
  </style>
</head>
<body>
  <div class="container">
    <h1>Checkout</h1>
    <div class="grid">
      <form class="card" id="checkout-form">
        <h3>Customer Details</h3>
        <input type="text" id="c_name" placeholder="Full name" required>
        <input type="email" id="c_email" placeholder="Email" required>
        <input type="tel" id="c_phone" placeholder="Phone (10 digits)" required>
        <input type="text" id="c_address" placeholder="Address" required>
        <input type="text" id="c_city" placeholder="City / Town" required>
        <input type="text" id="c_pincode" placeholder="Pincode / ZIP" required>
        <button class="pay-btn" type="submit">Pay Securely</button>
      </form>

      <aside class="card">
        <h3>Order Summary</h3>
        <div id="order-items"></div>
        <div style="height:1px;background:#f1f5f9;margin:10px 0;border-radius:4px"></div>
        <div class="summary-line"><div>Subtotal</div><div id="sum-sub">₹0</div></div>
        <div class="summary-line"><div>Shipping</div><div id="sum-ship">₹0</div></div>
        <div class="summary-line" style="font-weight:700"><div>Total</div><div id="sum-total">₹0</div></div>
      </aside>
    </div>
  </div>

  <!-- Razorpay checkout script will be injected dynamically -->
  <script>
    const cartKey = 'birru_cart_v1';
    function loadCart(){ return JSON.parse(localStorage.getItem(cartKey) || '[]'); }
    function renderOrder(){
      const cart = loadCart();
      const container = document.getElementById('order-items');
      container.innerHTML = '';
      cart.forEach(p=>{
        const el = document.createElement('div');
        el.style.display='flex'; el.style.justifyContent='space-between'; el.style.margin='8px 0';
        el.innerHTML = `<div>${p.name} x ${p.qty}</div><div>₹${p.price * p.qty}</div>`;
        container.appendChild(el);
      });
      const sub = cart.reduce((s,p)=> s + p.price*p.qty, 0);
      const ship = sub > 1000 ? 0 : 0;
      const total = sub + ship;
      document.getElementById('sum-sub').textContent = '₹' + sub;
      document.getElementById('sum-ship').textContent = '₹' + ship;
      document.getElementById('sum-total').textContent = '₹' + total;
    }
    renderOrder();

    // -- Checkout flow:
    // 1) On submit, collect customer details and cart
    // 2) POST to /api/create-order  (server must create Razorpay order and return order_id and key_id)
    // 3) Open Razorpay checkout with returned options
    // IMPORTANT: Replace endpoint if using different host

    document.getElementById('checkout-form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const cart = loadCart();
      if(cart.length===0){ alert('Cart empty'); return; }

      const customer = {
        name: document.getElementById('c_name').value.trim(),
        email: document.getElementById('c_email').value.trim(),
        phone: document.getElementById('c_phone').value.trim(),
        address: document.getElementById('c_address').value.trim(),
        city: document.getElementById('c_city').value.trim(),
        pincode: document.getElementById('c_pincode').value.trim()
      };
      // validate minimally
      if(!customer.name || !customer.email || !customer.phone){ alert('Please fill required fields'); return; }

      // prepare payload
      const payload = { cart, customer };

      try {
        // call your server endpoint to create order
        const resp = await fetch('/api/create-order', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });
        if(!resp.ok) throw new Error('Server error');
        const data = await resp.json();
        // data should include: { orderId, amount, currency, key_id }
        const options = {
          key: data.key_id, // razorpay key id
          amount: data.amount, // in paise
          currency: data.currency || 'INR',
          name: 'Birru Wellness Store',
          description: 'Order #' + (data.orderId || ''),
          order_id: data.orderId,
          handler: function (response){
            // response.razorpay_payment_id, razorpay_order_id, razorpay_signature
            // You should verify payment on server side before confirming
            alert('Payment successful! Payment ID: ' + response.razorpay_payment_id);
            // clear cart and redirect to success page
            localStorage.removeItem(cartKey);
            window.location.href = '/thankyou.html';
          },
          prefill: {
            name: customer.name,
            email: customer.email,
            contact: customer.phone
          },
          theme: { color: '#0b6b9e' }
        };
        // load razorpay script on the fly
        const script = document.createElement('script');
        script.src = 'https://checkout.razorpay.com/v1/checkout.js';
        script.onload = ()=>{
          const rzp = new window.Razorpay(options);
          rzp.open();
        };
        document.body.appendChild(script);
      } catch (err){
        console.error(err);
        alert('Failed to start payment. See console for details.');
      }
    });
  </script>
</body>
</html>
